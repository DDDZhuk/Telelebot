# Fastcoin-Бот
Это краткая документация по боту.

## Как запустить го
### Настройка окружения
Создайте `.env` файл в папке с ботом и откройте его в текстовом редакторе.
Заполните его следующим образом:
```
export BOT_TOKEN=172195613:BBFxbrBuVxPFj6ckKIqPraLv81c19Rad34Q
export WEBHOOK_URL=webhook.example.com
export PRIVATE_KEY=0e37e5feb349ce0c8е03963ddd4163b19k171b0be9ad1c7a7fe266edaedcf3
export ADMIN=205279061
export CARD_NUMBER="1231 213 1233 1323"
```
#### Описание
1) Токен бота, который вы болучается от BotFather
2) URL вебхука на который будут приходить сообщения [см. документацию BOT API](https://core.telegram.org/bots/api#setwebhook)
3) Приватный ключ от главного Bitcoin-кошелька, [см. документация Bitcoin](https://en.bitcoin.it/Private_key)
4) Telegram-Id администратора, можно получить в [@myidbot](https://t.me/myidbot)
5) Номер Сбербанк-карты для перевода

### Установка зависимостей
Для работы бота необходимо установить следующие зависимости:
* Python 3.x
* Redis-server
* Произвести установки библиотек с помощью PIP: `pip3 install -r requirements.txt`

### Запуск
1) Обновите окружение, добавив переменные из файла `.env` с помощью команды `source .env`
2) Запустите redis-server: `redis-server`
3) Для тестового запуска бота, можете воспользоваться стандартным интепритатором Python:  `python3 app.py`
4) Для продакшена советую воспользоваться [Gunicorn](http://gunicorn.org): `gunicorn app:app`

## Структура бота
## Bot-Core
Ядро бота состоит из двух модулей в корне проекта: `app.py` и `bot.py`

Первый модуль представляет из себя стартовый модуль, который запускает и инициализирует бота, он отвечает за создание `Flask` веб-приложения, создание объекта бота, инициализацию бота и вебхуков, получение и обработку данных с вебхуков.

`Bot.py` отвечает за класс `Bot`, который как представляет из центральную часть прилоежения, которая отвечает за работу бота. В нем описаны методы работы с: базой данных, Telegram API, обработку сообщений пользователя, загрузку модулей бота, работу с пользовательской сессией, генерирование пользовательских клавиатур и сообщений из шаблонов.
    
## Modules
Модули представляют из себя некоторые скрипты, сценарии, которым бот передает сообщения от пользователя, а они в свою очередь решают что делать в той или иной ситуации. 
Модули состоят из некоторых функций обработчиков **handler**'ов. Самое первое сообщение пользователя обрабатывается стандартным хендлером, который указан в конфиге в дальнейшей работе бота хендлеры могут не только получать данные, но и указывать какой хендлер будет обрабатывать следующее сообщение. Таким образом строится неявный граф обработки сообщений пользователя.

Внутри модулей хендлеры могут оперировать любой информацией: 
* Получать и записывать данные в базу данных
* Отправлять сообщение через Telegram API
* Запрашивать или отправлять средства по средствам Bitcoin API
* Отрисовывать пользовательские клавиатуры
* И многое другое..

## Config
Конфиги представляют из себя статические JSON-файлы, которые хранят необходимую боту информацию. На данный момент в боте существует три конфиг-файлов: `init.json`, `keyboards.json`, `messages.json`.

Первый файл отвечает за основные настройки бота:
* **default-handler** - стандартный обработчик сообщения, когда пользователь пишет первый раз или не указан обработчик который будет обрабатывать следующее собщение
* **menu-button** - сообщение при получении которого, бот всегда будет возвращаться в главное меню
* **comission** - Bitcoin комиссия для совершения транзакции, указвается в **сатоши!**

**keyboards.json** - отвечает за хранение шаблонов клавиатур, о работе с которыми вы можете прочитать далее
**messages.json** - отвечает за хранение шаблонов сообщений, о работе с которыми вы можете прочитать далее

## Bitcoin API
Для работы с **Bitcoin** используется библиотека [pybitcointools](https://github.com/vbuterin/pybitcointools), которая была склонирована в папку с проектом и дописана для совместимости с третьим питоном.

За работу кошельков отвечают два модуля: `wallet.py` и `main_wallet.py`. Первый - отвечает за работу с кошельками пользователей, второй - за работу с главным кошельком.